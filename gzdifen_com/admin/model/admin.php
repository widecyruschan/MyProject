<?phpout();$id=verify_id($_POST['id'].$_GET['id']);$user=str_check($_POST['user']);$name=str_check($_POST['name']);$password=str_check($_POST['password']);$permissions=str_check($_POST['permissions']);$permissions=serialize($permissions);function randstr($len=6) {$chars='abcdefghijklmnopqrstuvwxyz0123456789';mt_srand((double)microtime()*1000000*getmypid());$password='';while(strlen($password)<$len) $password.=substr($chars,(mt_rand()%strlen($chars)),1);return $password;}$salt=randstr();if($action=="edit"){$db->query("SELECT * FROM  `{$DB_dbprefix}admin` WHERE  `user` = '$user' AND `id` != '$id' LIMIT 0 , 1");if ( !$db->next_record( ) ){if($password!=""){$password=md5(md5($password).$salt);$db->query( "UPDATE  `{$DB_dbprefix}admin` SET  `user` =  '$user',`name` =  '$name',`password` =  '$password',`salt` =  '$salt',`permissions` =  '$permissions' WHERE  `id` =$id;");}else{$db->query( "UPDATE  `{$DB_dbprefix}admin` SET  `user` =  '$user',`name` =  '$name',`permissions` =  '$permissions' WHERE  `id` =$id;");}addlog( "添加管理员{$user}",$_SESSION['admin_user'] );done('添加成功','','');}else{fail('检测到有相同的账号名，请修改后再次提交');}exit();}if($action=="add"){$db->query("SELECT * FROM  `{$DB_dbprefix}admin` WHERE  `user` = '$user' LIMIT 0 , 1");if ( !$db->next_record( ) ){$password=md5(md5($password).$salt);$db->query("INSERT INTO `{$DB_dbprefix}admin` (`id` ,`user` ,`name` ,`password` ,`salt` ,`permissions` )VALUES (NULL ,   '{$user}',  '{$name}',  '{$password}', '{$salt}',  '{$permissions}' );");addlog( "添加管理员{$user}",$_SESSION['admin_user'] );done('添加成功','','');}else{fail('检测到有相同的账号名，请修改后再次提交');}exit();}if($action=='del'){$db->query( "DELETE FROM {$DB_dbprefix}admin WHERE id=$id; ");addlog( "删除管理员$id",$_SESSION['admin_user'] );done('删除成功','','');exit();}?>