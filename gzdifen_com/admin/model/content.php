<?phpout();$id=verify_id($_GET['id']);$cid=verify_id($_GET['columns']);$module=str_check($_GET['module']);$title=str_check($_POST['title']);$subtitle=str_check($_POST['subtitle']);$hide=verify_id($_POST['hide']);$description=str_check($_POST['description']);$keywords=str_check($_POST['keywords']);$permute=verify_id($_POST['permute']);$content=str_check($_POST['content']);$url=str_check($_POST['url']);$ids=str_check($_POST['ids']);$module_id=verify_id($_POST['module_id']);$module_alias=str_check($_POST['module_alias']);$module_serialize_content=str_check($_POST['module_serialize_content']);$module_serialize_content=str_replace('\"','"',$module_serialize_content);$module_content=unserialize($module_serialize_content);if($action=='alldel'){$db->query("DELETE  FROM  `{$DB_dbprefix}content` WHERE  `id` in ($ids) ");addlog( "批量删除内容",$_SESSION['admin_user']);done('批量删除成功','','');exit();}if($module=='url'){$db->query( "UPDATE  `{$DB_dbprefix}columns` SET  `url` =  '$url',`time` =  '".time()."' WHERE  `id` =$id; ");addlog( "修改栏目内容$id",$_SESSION['admin_user']);done('修改成功','navNewsLi','closeCurrent');exit();}if($module=='singlepage'){$db->query( "UPDATE  `{$DB_dbprefix}columns` SET  `description` =  '$description',`keywords` =  '$keywords',`content` =  '$content',`time` =  '".time()."' WHERE  `id` =$id; ");addlog( "修改栏目内容$id",$_SESSION['admin_user']);done('修改成功','','');exit();}if($action=='add'){if(is_array($module_content)) for($i=0;$i<count($module_content);$i++) {$module_sql_1.=",`".$module_content[$i]["alias"]."`";$module_sql_2.=",'".str_check($_POST["z_".$module_content[$i]["alias"]])."'";}$db->query("SELECT * FROM  `{$DB_dbprefix}content` WHERE  `subtitle` =  '$subtitle'  AND `subtitle` !=  '' LIMIT 0 , 1");if ( !$db->next_record( ) ){$db->query( "INSERT INTO `{$DB_dbprefix}content` (`id`, `title`, `cid`, `subtitle`, `hide`, `description`, `keywords`, `permute`, `time`) VALUES (NULL, '$title', '$cid', '$subtitle', '$hide', '$description', '$keywords', '$permute', '".time()."');");$insert_id = mysql_insert_id( );$db->query( "INSERT INTO `{$DB_dbprefix}z_{$module_alias}` (`id`, `bid` {$module_sql_1}) VALUES (NULL, '$insert_id' {$module_sql_2});");addlog( "添加内容",$_SESSION['admin_user']);done('操作成功','navNewsLi','closeCurrent');}else{fail('检测到有相同的保存名，请修改后再次提交');}exit();}if($action=='edit'){if(is_array($module_content)) for($i=0;$i<count($module_content);$i++) {if($i=="1"){$separated= ",";}$module_sql.= $separated."`".$module_content[$i]["alias"]."`='".str_check($_POST["z_".$module_content[$i]["alias"]])."'";}$db->query("SELECT * FROM  `{$DB_dbprefix}content` WHERE  `subtitle` =  '$subtitle' AND `id` !=  '$id' AND `subtitle` !=  ''  LIMIT 0 , 1");if ( !$db->next_record( ) ){$db->query( "UPDATE  `{$DB_dbprefix}content` SET  `title` =  '$title',`subtitle` =  '$subtitle',`hide` =  '$hide',`description` =  '$description',`keywords` =  '$keywords',`permute` =  '$permute',`time` =  '".time()."' WHERE  `id` =$id; ");$db->query( "UPDATE  `{$DB_dbprefix}z_{$module_alias}` SET  {$module_sql} WHERE  `bid` =$id LIMIT 1 ;");addlog( "修改内容$id",$_SESSION['admin_user'] );done('修改成功','navNewsLi','closeCurrent');}else{fail('检测到有相同的保存名，请修改后再次提交');}exit();}if($action=='del'){$db->query("DELETE  FROM  `{$DB_dbprefix}content` WHERE  `id` ='{$id}' ");$db->query( "SELECT * from {$DB_dbprefix}module WHERE id=$module ");if ($db->next_record()){$module_alias             = $db->Record['alias'];}$db->query("DELETE  FROM  `{$DB_dbprefix}z_{$module_alias}` WHERE  `bid` ={$id} LIMIT 1");addlog( "删除内容$id",$_SESSION['admin_user'] );done('删除成功','','');exit();}?>