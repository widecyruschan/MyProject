<?phpout();$id=verify_id($_GET['id']);$fp = fopen("../lib/module.php","r+");$writing = fread($fp,filesize("../lib/module.php"));fclose($fp);$fp2 = fopen("../view.php","r+");$writing2 = fread($fp2,filesize("../view.php"));fclose($fp2);if($action=='del'){$db->query("SELECT * FROM  `{$DB_dbprefix}columns` WHERE  `module` ={$id} LIMIT 1");if ( !$db->next_record( ) )	{$db->query("SELECT * FROM  `{$DB_dbprefix}module` WHERE  `id` ={$id} LIMIT 1");if ($db->next_record( ) ){$str = preg_replace ('/\/\*('.$db->Record['alias'].'_start)\*\/(.|\n)*\/\*('.$db->Record['alias'].'_end)\*\//U'," ",$writing);$str2 = preg_replace ('/\/\*('.$db->Record['alias'].'_start)\*\/(.|\n)*\/\*('.$db->Record['alias'].'_end)\*\//U'," ",$writing2);$fp = fopen("../lib/module.php","w") or die( '{"statusCode":"300", "message":"写入模块失败，请检查../lib目录是否有写入权限"}');;$fp2 = fopen("../view.php","w") or die( '{"statusCode":"300", "message":"写入模块失败，请检查view.php是否有写入权限"}');;fwrite($fp,$str);fwrite($fp2,$str2);fclose($fp);fclose($fp2);$db->query( "DELETE FROM {$DB_dbprefix}module WHERE id={$id}; ");$db->query( "DROP TABLE  `{$DB_dbprefix}z_".$db->Record['alias']."` ");addlog( "删除模块".$db->Record['alias'],$_SESSION['admin_user'] );done('删除成功','navNewsLi','closeCurrent');}else{fail('模块不存在');}}else{fail('模块下有内容，无法删除');}exit;}if($action=='add'){foreach($_POST['required'] as $key=>$value){$module[$key]['required']=$_POST['required'][$key];$module[$key]['type']=$_POST['type'][$key];$module[$key]['name']=$_POST['name'][$key];$module[$key]['alias']=$_POST['alias'][$key];$module[$key]['text']=$_POST['text'][$key];}$module_name=str_check($_POST['module_name']);$module_alias=str_check($_POST['module_alias']);$serialize=str_check(serialize($module));$result = $db->query( "show tables");while($row = mysql_fetch_array($result)) {if($row[0]==$DB_dbprefix."z_".$module_alias){die('{"statusCode":"300", "message":"添加失败，已经存在这个表名"}');}}mysql_free_result($result);$db->query( "INSERT INTO  `{$DB_dbprefix}module` (`id` ,`name` ,`alias` ,`content` ,`time`)VALUES (NULL ,  '{$module_name}','{$module_alias}',  '{$serialize}',  '".time()."');");$str.='/*'.$module_alias.'_start*/';$str2.='/*'.$module_alias.'_start*/';if(is_array($module)) for($i=0;$i<count($module);$i++) {if ($module[$i]['type']=="editor"){$type="MEDIUMTEXT";}elseif($module[$i]['type']=="digit"or $module[$i]['type']=="time"){$type="int( 11 )";}else{$type="VARCHAR( 200 )";}$create_sql.=",`".$module[$i]['alias']."` ".$type." CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL  COMMENT  '".$module[$i]['text']."'";if($module[$i]['type']=="upload"){$str.=",\r\n'".$module_alias."_".$module[$i]["alias"]."'=>\$web_dir.\$upfile.stride('".$module[$i]["alias"]."','z_".$module_alias."','bid',\$db->Record['id'])";$str2.="\r\n\$".$module_alias."_".$module[$i]["alias"]."=\$web_dir.\$upfile.stride('".$module[$i]["alias"]."','z_".$module_alias."','bid',\$db->Record['id']);";}elseif($module[$i]['type']=="multiple"){$str.=",\r\n'".$module_alias."_".$module[$i]["alias"]."'=>multiple(stride('".$module[$i]["alias"]."','z_".$module_alias."','bid',\$db->Record['id']))";$str2.="\r\n\$".$module_alias."_".$module[$i]["alias"]."=multiple(stride('".$module[$i]["alias"]."','z_".$module_alias."','bid',\$db->Record['id']));";}else{$str.=",\r\n'".$module_alias."_".$module[$i]["alias"]."'=>uh(stride('".$module[$i]["alias"]."','z_".$module_alias."','bid',\$db->Record['id']))";$str2.="\r\n\$".$module_alias."_".$module[$i]["alias"]."=stride('".$module[$i]["alias"]."','z_".$module_alias."','bid',\$db->Record['id']);";}}$str.='/*'.$module_alias.'_end*/';$str2.='/*'.$module_alias.'_end*/';$writing2 = str_replace("/*view_module_end*/",$str2."\r\n/*view_module_end*/",$writing2);$writing = str_replace("/*columns_module_end*/",$str."\r\n/*columns_module_end*/",$writing);$writing = str_replace("/*classpage_module_end*/",$str."\r\n/*classpage_module_end*/",$writing);@chmod('../lib',0777);$fp = fopen("../lib/module.php","w") or die( '{"statusCode":"300", "message":"写入模块失败，请检查../lib目录是否有写入权限"}');;fwrite($fp,$writing);fclose($fp);$fp2 = fopen("../view.php","w") or die( '{"statusCode":"300", "message":"写入模块失败，请检查../lib目录是否有写入权限"}');;fwrite($fp2,$writing2);fclose($fp2);$db->query( "CREATE TABLE  `{$DB_dbprefix}z_".$module_alias."` (`id` INT( 11 ) NOT NULL AUTO_INCREMENT PRIMARY KEY ,`bid` INT( 11 ) NOT NULL ".$create_sql." ) ENGINE = MYISAM;");addlog( "添加模块",$_SESSION['admin_user']);done('添加模块成功','navNewsLi','closeCurrent');}?>