<?phpfunction cnsubstr($sourcestr,$cutlength) //剪辑字串{    $returnstr='';    $i=0;    $n=0;    $str_length=strlen($sourcestr);   while (($n<$cutlength) and ($i<=$str_length))    {       $temp_str=substr($sourcestr,$i,1);       $ascnum=Ord($temp_str);      if ($ascnum>=224)          {          $returnstr=$returnstr.substr($sourcestr,$i,3);                   $i=$i+3;                   $n++;               }      elseif ($ascnum>=192)       {          $returnstr=$returnstr.substr($sourcestr,$i,2);          $i=$i+2;                    $n++;                }      elseif ($ascnum>=65 && $ascnum<=90)       {          $returnstr=$returnstr.substr($sourcestr,$i,1);          $i=$i+1;                     $n++;                  }      else                      {          $returnstr=$returnstr.substr($sourcestr,$i,1);          $i=$i+1;                     $n=$n+0.5;              }    }          if ($str_length/3>$cutlength){          $returnstr = $returnstr . "...";      }    return $returnstr; }function links($cid,$num,$type)//友情链接(栏目，数量，类型){   global $DB_dbprefix,$DB_Database, $DB_Host, $DB_User, $DB_Password,$web_dir,$upfile;	    $db2 = new DB_Sql;						//初始化数据库        $db2->connect($DB_Database, $DB_Host, $DB_User, $DB_Password); //数据库连接		$db2->query("SELECT * FROM {$DB_dbprefix}links where type=".$type." AND `column` =  '".$cid."' Order by `permute` DESC ,id desc limit 0,".$num);		$links_array = array();		while($db2->next_record())		{			if(!stristr($db2->Record["pic"],strtolower("http://"))){                  $pic=$web_dir.$upfile.$db2->Record["pic"];            }else{                  $pic=$db2->Record["pic"];            }			//把结果存成二维数组			$links_array[] = array(				'title' 	=> $db2->Record["title"],				'pic' 		=> @$pic,				'url'    	=> $db2->Record["url"],				'note'   	=> $db2->Record["note"]			);	}	return $links_array;	unset($links_array);}function delindexhtml( $id, $indexname)//删除首页{				global $db,$DB_dbprefix;				$sql= "SELECT web_html_mode FROM {$DB_dbprefix}config WHERE id =".$id;				$db->query( $sql);				if ( $db->next_record( ) && $db->Record['web_html_mode'] != $indexname&& $db->Record['web_html_mode'] != "php" )				{								@unlink( "../index.".$db->Record['web_html_mode'] );												}}function PHPCMSlink($id,$addtime)//内容页链接{global $web_html_name,$web_dir,$web_html_dir,$web_html_mode,$DB_dbprefix;if($web_html_mode=="php"){	$PHPCMSurl=$web_dir."view.php?id=".$id;}else{		switch ($web_html_name){		case 1:				if(stride('subtitle','content','id',$id)!=""){			  $PHPCMSurl=$web_dir.$web_html_dir."view_".stride('subtitle','content','id',$id).".".$web_html_mode;		}else{              $PHPCMSurl=$web_dir.$web_html_dir."view_".$id.".".$web_html_mode;		}		break;		case 2: 			$PHPCMSurl=$web_dir.$web_html_dir.date("Ymdgis",$addtime).".".$web_html_mode;		break;		case 3:		    if(stride('subtitle','content','id',$id)!=""){					$PHPCMSurl=$web_dir.$web_html_dir.stride('subtitle','content','id',$id)."/";	            	}else{                    $PHPCMSurl=$web_dir.$web_html_dir.$id."/";		      }					break;			}	}return $PHPCMSurl;}function getSort($num,&$orArray){//获取所有子栏目idglobal $db,$DB_dbprefix; $sql = "select * from {$DB_dbprefix}columns where bid=".$num; $result = $db->query($sql); if($result){  $search = array();  while($row=mysql_fetch_assoc($result)){   $orArray[] = $row['id'];   $search[] = $row['id'];  }  foreach($search as $key=>$value){   getSort($value,$orArray);  } }}function showpage($mode,$style,$nowindex_style)//分页{global $intPerpage,$intNum,$classid,$execc,$web_html_mode,$web_html_dir,$web_dir,$keyword,$DB_dbprefix;$resultc=mysql_query($execc);$intNum=mysql_num_rows($resultc);if($web_html_mode=="php" || isset($keyword)){$page=new page(array('total'=>$intNum,'perpage'=>$intPerpage));}else{$page=new page(array('total'=>$intNum,'perpage'=>$intPerpage,'url'=>$web_dir.$web_html_dir."class_".$classid));$page->page_webmode = $web_html_mode;}return $page->show($mode,$style,$nowindex_style);}function wfile($filename,$string,$mode= "w" )//写入文件{				$file=fopen($filename,$mode);				if (!$file)				{								return false;				}				fwrite($file, $string);				fclose($file);				return true;}function stride($tablesname,$tables,$requirement,$id)//跨数据表读取{ 	global $DB_dbprefix,$DB_Database, $DB_Host, $DB_User, $DB_Password;	$db1 = new DB_Sql;						//初始化数据库    $db1->connect($DB_Database, $DB_Host, $DB_User, $DB_Password); //数据库连接    mysql_query("set names utf8");	$db1->query("SELECT $tablesname FROM $DB_dbprefix$tables WHERE $requirement='".$id."'");	if($db1->next_record()) 	{         return $db1->Record[$tablesname];     }}function getIP()//获取访问IP地址{				if ( getenv( "HTTP_CLIENT_IP" ) )				{								$_httpip = getenv( "HTTP_CLIENT_IP" );								return $_httpip;				}				if ( getenv( "HTTP_X_FORWARDED_FOR" ) )				{								$_httpip = getenv( "HTTP_X_FORWARDED_FOR" );								return $_httpip;				}				if ( getenv( "HTTP_X_FORWARDED" ) )				{								$_httpip = getenv( "HTTP_X_FORWARDED" );								return $_httpip;				}				if ( getenv( "HTTP_FORWARDED_FOR" ) )				{								$_httpip = getenv( "HTTP_FORWARDED_FOR" );								return $_httpip;				}				if ( getenv( "HTTP_FORWARDED" ) )				{								$_httpip = getenv( "HTTP_FORWARDED" );								return $_httpip;				}				$_httpip = $_SERVER['REMOTE_ADDR'];				return $_httpip;}function addlog( $content, $user)//添加操作日志{				global $db,$DB_dbprefix;				$time = time();				$ip = getenv('REMOTE_ADDR');				$db->query( "INSERT INTO {$DB_dbprefix}log(  `content` ,  `time` ,  `user` ,  `ip` ) VALUES ('{$content}',  '{$time}',  '{$user}',  '".getIP()."');" );}function done($message,$navTabId,$callbackType){//返回操作成功信息	echo '{	"statusCode":"200",	"message":"'.$message.'"';	if($navTabId!=""){		echo ',"navTabId":"'.$navTabId.'"';     }	 if($callbackType!=""){	 echo ',"callbackType":"'.$closeCurrent.'"';	 }	 echo '}';	 exit();}function fail($message){//返回操作失败信息	die( '{"statusCode":"300", "message":"'.$message.'"}');}function template($file)//读取模板文件{	global $tpl_default_dir,$t;	$str=$t->tpl_read($tpl_default_dir."/".$file);	$str=$t->tpl_parse($str);	$tpldir=str_replace(".htm","",$tpl_default_dir.".tpl/".$file.".tpl.php");	$t->tpl_write($tpldir,$str);	return $tpldir;}function navigation($type){      global $db,$web_dir,$web_html_dir,$web_html_mode,$DB_dbprefix,$id,$DB_Database, $DB_Host, $DB_User, $DB_Password,$bid,$cid;     $class_array = array();   $i=0;   $db2 = new DB_Sql;						//初始化数据库   $db2->connect($DB_Database, $DB_Host, $DB_User, $DB_Password); //数据库连接   if($type==1){        // $class_array[] = array(                 // 'title'  => "首页",                 // 'num'  => $i=1,                 // 'url'  => $web_dir,                 // 'ids'  => 0       //  );		       $db2->query("SELECT * FROM {$DB_dbprefix}columns where bid=0 and hide=0 Order by permute desc,id asc");       while($db2->next_record())        {			if($db2->Record["module"]=='url'){                   $class_array[] = array(                          'title'  => $db2->Record["title"],                          'num'  => $i+=1,                          'url'  => $db2->Record["url"],                          'ids'  => $db2->Record["id"]                    );              }else{				    $class_array[] = array(                          'title'  => $db2->Record["title"],                          'num'  => $i+=1,                          'url'  => classlink($db2->Record["id"]),                          'ids'  => $db2->Record["id"]                    );			  }        }   }   if($type==2){	   $db2->query("SELECT * FROM {$DB_dbprefix}columns where bid=".$id."");//获取栏目数据       if ($db2->next_record())	   {	      $db2->query("SELECT * FROM {$DB_dbprefix}columns where bid=$id and hide=0 Order by permute desc,id asc");          while($db2->next_record())          {			  if($db2->Record["module"]=='url'){                   $class_array[] = array(                          'title'  => $db2->Record["title"],                          'num'  => $i+=1,                          'url'  => $db2->Record["url"],                          'ids'  => $db2->Record["id"]                    );              }else{				    $class_array[] = array(                          'title'  => $db2->Record["title"],                          'num'  => $i+=1,                          'url'  => classlink($db2->Record["id"]),                          'ids'  => $db2->Record["id"]                    );			  }           }	   }else{		   $db2->query("SELECT * FROM {$DB_dbprefix}columns where bid=$bid and hide=0 Order by permute desc,id asc");           while($db2->next_record()){		     if($db2->Record["module"]=='url'){                   $class_array[] = array(                          'title'  => $db2->Record["title"],                          'num'  => $i+=1,                          'url'  => $db2->Record["url"],                          'ids'  => $db2->Record["id"]                    );              }else{				    $class_array[] = array(                          'title'  => $db2->Record["title"],                          'num'  => $i+=1,                          'url'  => classlink($db2->Record["id"]),                          'ids'  => $db2->Record["id"]                    );			  }		   }			  	   }   }   if($type==3){	   	   $db2->query("SELECT * FROM {$DB_dbprefix}columns where bid=".stride('bid','columns',"id",$cid)." and hide=0 Order by permute desc,id asc");       while($db2->next_record())        {			if($db2->Record["module"]=='url'){                   $class_array[] = array(                          'title'  => $db2->Record["title"],                          'num'  => $i+=1,                          'url'  => $db2->Record["url"],                          'ids'  => $db2->Record["id"]                    );              }else{				    $class_array[] = array(                          'title'  => $db2->Record["title"],                          'num'  => $i+=1,                          'url'  => classlink($db2->Record["id"]),                          'ids'  => $db2->Record["id"]                    );			  }        }   }   return $class_array;   unset($class_array);	}function Subnavigation($_menu){   global $id,$DB_dbprefix,$DB_Database, $DB_Host, $DB_User, $DB_Password,$bid,$cid;   $class_array = array();   $db3 = new DB_Sql;						//初始化数据库   $db3->connect($DB_Database, $DB_Host, $DB_User, $DB_Password); //数据库连接	$db3->query("SELECT * FROM {$DB_dbprefix}columns where bid=".$_menu." Order by permute desc,id asc");		while($db3->next_record())	{$class_array[] = array(	'titles'  => $db3->Record["title"],	'ids'  =>  $db3->Record["id"],	'classurl'  =>  classlink($db3->Record["id"]),	);	}	return $class_array;unset($class_array);}function classlink($id)//获取链接地址{global $web_dir,$web_html_dir,$web_html_mode,$DB_dbprefix;if($web_html_mode=="php"){	$class=$web_dir."class.php?id=".$id;}else{	if(stride('subtitle','columns','id',$id)!=""){		      $class=$web_dir.$web_html_dir.stride('subtitle','columns','id',$id).".".$web_html_mode;		}else{              $class=$web_dir.$web_html_dir."class_".$id.".".$web_html_mode;		}}return $class;}function columnurl($id)//获取链接地址{global $web_dir,$web_html_dir,$web_html_mode,$DB_dbprefix;if($web_html_mode=="php"){	$class=$web_dir."class.php?id=".$id;}else{	if(stride('subtitle','columns','id',$id)!=""){		      $class=$web_dir.$web_html_dir.stride('subtitle','columns','id',$id).".".$web_html_mode;		}else{              $class=$web_dir.$web_html_dir."class_".$id.".".$web_html_mode;		}}echo $class;}function uh($str) //过滤html{ $farr = array( "/\s+/" , //过滤多余的空白 "/<(\/?)(script|META|STYLE|HTML|HEAD|BODY|STYLE |i?frame|b|strong|style|html|img|P|o:p|iframe|u|em|strike|BR|div|a|TABLE|TBODY|object|tr|td|st1:chsdate|FONT|span|MARQUEE|body|title|\r\n|link|meta|\?|\%)([^>]*?)>/isU" , //过滤 <script 防止引入恶意内容或恶意代码,如果不需要插入flash等,还可以加入<object的过滤 "/(<[^>]*)on[a-zA-Z]+\s*=([^>]*>)/isU" , //过滤javascript的on事件 ); $tarr = array( " " , "" , //如果要直接清除不安全的标签，这里可以留空 "\\1\\2" , ); $str = preg_replace ( $farr , $tarr , $str ); $str2 = str_replace ('<','&lt;' , $str ); $str3 = str_replace ('>','&gt;' , $str2 ); return $str3 ; }function single($id,$string,$filter,$substr)//获取栏目某字段信息,$id=栏目ID,$string=字串名,$filter=0不过滤html,$filter=1过滤html,$substr=截取长度{	$single=stride($string,'columns','id',$id);	if($filter==1){		$single=uh($single);	}	if($substr>0){		$single=cnsubstr($single,$substr);	}	echo $single;}function upload(){}function multiple(){}function location($TemplateType,$_id){function get_path($node){global $web_dir,$web_html_dir,$web_html_mode,$DB_dbprefix;$result=mysql_query('select * from '.$DB_dbprefix.'columns where id='.$node.' ');$row=mysql_fetch_array($result);$path=array();if($web_html_mode=="php"){$classurl=$web_dir."class.php?id=".$row['id'];}else{$classurl=$web_dir.$web_html_dir."class_".$row['id'].".".$web_html_mode;}if($row['bid']!=''){$path[]="<a href=".$classurl." alt=".$row['title']."/>".$row['title']."</a>>";$path=array_merge(get_path($row['bid']),$path);}return $path;}if($TemplateType=="class"){foreach(get_path($_id) as $path){         $newpath.=$path;         }   global $web_dir;   return "<a href=\"".$web_dir."\" alt=\"".$web_name."\">首页</a>>".$newpath."";}else if($TemplateType=="view"){foreach(get_path($_id) as $path){         $newpath.=$path;         }   global $web_dir;   return "<a href=\"".$web_dir."\" alt=\"".$web_name."\">首页</a>>".$newpath."";}switch ($TemplateType){case "index":return "<a href=\"".$web_dir."\">首页</a>>";break;case "class":return $echoloction;break;case "search":return "<a href=\"".$web_dir."\">首页</a>><a>网站搜索</a>>";break;case "view":return $echoloction;break;case "notice":return "<a href=\"".$web_dir."\">首页</a>><a>站内公告</a>>";break;}}function createFolder( $foldername ){				if ( !file_exists( $foldername ) )				{								createfolder( dirname( $foldername ) );								mkdir( $foldername, 511 );				}}function flash($columns,$Style,$Slidewidth,$Slideheight){global $db,$web_dir,$DB_dbprefix,$upfile;$pic="";$links="";$texts="";$i=0;switch ($Style){case 1:$FlashSlide="<script type=\"text/javascript\">\n"."var focus_width=".$Slidewidth."\n"."var focus_height=".$Slideheight."\n"."var text_height=0\n"."var swf_height = focus_height+text_height\n";$db->query("SELECT * FROM {$DB_dbprefix}slides WHERE cid=$columns Order by permute desc");while($db->next_record()){if(stristr($db->Record["pic"],strtolower("http://"))){$images=$db->Record["pic"];}else{$images=$web_dir.$upfile.$db->Record["pic"];}$i++;$FlashSlide.="imgUrl$i=\"".$images."\";\n";$FlashSlide.="imgtext$i=\"".$db->Record["title"]."\";\n";$FlashSlide.="imgLink$i=escape(\"".$db->Record["url"]."\");\n";$pic.="imgUrl$i+\"|\"+";$links.="imgLink$i+\"|\"+";$texts.="imgtext$i+\"|\"+";}$FlashSlide.="var pics=".rtrim($pic,"+\"|\"+")."\n"."var links=".rtrim($links,"+\"|\"+")."\n"."var texts=".rtrim($texts,"+\"|\"+")."\n"."document.write('<object classid=\"clsid:d27cdb6e-ae6d-11cf-96b8-444553540000\" codebase=\"http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0\" width=\"'+ focus_width +'\" height=\"'+ swf_height +'\">');\n"."document.write('<param name=\"allowScriptAccess\" value=\"sameDomain\"><param name=\"movie\" value=\"".$web_dir."lib/FlashSlide/Style".$Style."/flash.swf\"><param name=\"quality\" value=\"high\"><param name=\"bgcolor\" value=\"#F0F0F0\">');\n"."document.write('<param name=\"menu\" value=\"false\"><param name=wmode value=\"opaque\">');"."document.write('<param name=\"FlashVars\" value=\"pics='+pics+'&links='+links+'&texts='+texts+'&borderwidth='+focus_width+'&borderheight='+focus_height+'&textheight='+text_height+'\">');\n"."document.write('<embed src=\"".$web_dir."lib/FlashSlide/Style".$Style."/flash.swf\" wmode=\"opaque\" FlashVars=\"pics='+pics+'&links='+links+'&texts='+texts+'&borderwidth='+focus_width+'&borderheight='+focus_height+'&textheight='+text_height+'\" menu=\"false\" bgcolor=\"#F0F0F0\" quality=\"high\" width=\"'+ focus_width +'\" height=\"'+ focus_height +'\" allowScriptAccess=\"sameDomain\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" />');  document.write('</object>');\n"."</script>";break;case 2:$db->query("SELECT * FROM {$DB_dbprefix}slides WHERE cid=$columns  Order by permute desc");while($db->next_record()){if(stristr($db->Record["pic"],strtolower("http://"))){$images=$db->Record["pic"];}else{$images=$web_dir.$upfile.$db->Record["pic"];}$pic.="'".$images."',";$texts.="'".$db->Record["title"]."',";$links.="'".$db->Record["url"]."',";}$FlashSlide="<DIV style=\" OVERFLOW: hidden; WIDTH: $Slidewidth px; HEIGHT: $Slideheight px\"><SCRIPT language=JavaScript src=\"".$web_dir."lib/FlashSlide/Style".$Style."/slideshow.js\" type=text/javascript></SCRIPT>\n"."<SCRIPT language=JavaScript type=text/javascript>\n"."var mySlideList = [".rtrim($pic,",")."];\n"."var myAltList = [".rtrim($texts,",")."];\n"."var myLinkList = [".rtrim($links,",")."];\n"."var mySlideShow = new SlideShowSize(mySlideList,myAltList,myLinkList,'imgUnit',5000, 'mySlideShow',$Slidewidth,$Slideheight,0,800,600);\n"."mySlideShow.init();\n"."mySlideShow.play();\n"."</SCRIPT></DIV>";break;case 3:$FlashSlide="<script type=text/javascript>"."\n var pic_width=$Slidewidth;\n"."var pic_height=$Slideheight;\n"."var button_pos=4;\n"."var stop_time=3000;\n"."var show_text=0;\n"."var txtcolor=\"000000\";\n"."var bgcolor=\"DDDDDD\";\n"."var imag=new Array();\n"."var link=new Array();\n"."var text=new Array();\n";$db->query("SELECT * FROM {$DB_dbprefix}slides WHERE cid=$columns  Order by permute desc");while($db->next_record()){if(stristr($db->Record["pic"],strtolower("http://"))){$images=$db->Record["pic"];}else{$images=$web_dir.$upfile.$db->Record["pic"];}$i++;$FlashSlide.="imag[$i]=\"".$images."\";\n";$FlashSlide.="text[$i]=\"".$db->Record["title"]."\";\n";$FlashSlide.="link[$i]=\"".$db->Record["url"]."\";\n";}$FlashSlide.="var swf_height=show_text==1?pic_height+20:pic_height;\n"."var pics=\"\", links=\"\", texts=\"\";\n"."for(var i=1; i<imag.length; i++){\n"."pics=pics+(\"|\"+imag[i]);\n"."links=links+(\"|\"+link[i]);\n"."texts=texts+(\"|\"+text[i]);\n"."}\n"."pics=pics.substring(1);\n"."links=links.substring(1);\n"."texts=texts.substring(1);\n"."document.write('<object classid=\"clsid:d27cdb6e-ae6d-11cf-96b8-444553540000\" codebase=\"http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cabversion=6,0,0,0\" width=\"'+ pic_width +'\" height=\"'+ swf_height +'\">');\n"."document.write('<param name=\"movie\" value=\"".$web_dir."lib/FlashSlide/Style".$Style."/Flash.swf\">');\n"."document.write('<param name=\"quality\" value=\"high\"><param name=\"wmode\" value=\"opaque\">');\n"."document.write('<param name=\"FlashVars\" value=\"pics='+pics+'&links='+links+'&texts='+texts+'&pic_width='+pic_width+'&pic_height='+pic_height+'&show_text='+show_text+'&txtcolor='+txtcolor+'&bgcolor='+bgcolor+'&button_pos='+button_pos+'&stop_time='+stop_time+'\">');\n"."document.write('<embed src=\"".$web_dir."lib/FlashSlide/Style".$Style."/Flash.swf\" FlashVars=\"pics='+pics+'&links='+links+'&texts='+texts+'&pic_width='+pic_width+'&pic_height='+pic_height+'&show_text='+show_text+'&txtcolor='+txtcolor+'&bgcolor='+bgcolor+'&button_pos='+button_pos+'&stop_time='+stop_time+'\" quality=\"high\" width=\"'+ pic_width +'\" height=\"'+ swf_height +'\" allowScriptAccess=\"sameDomain\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" />');\n"."document.write('</object>');\n"."</script>";break;case 4:$FlashSlide="<script type=text/javascript>\n"."var swf_width=$Slidewidth \n"."var swf_height=$Slideheight \n";$db->query("SELECT * FROM {$DB_dbprefix}slides WHERE cid=$columns  Order by permute desc");while($db->next_record()){if(stristr($db->Record["pic"],strtolower("http://"))){$images=$db->Record["pic"];}else{$images=$web_dir.$upfile.$db->Record["pic"];}$i++;$pic.=$images."|";$links.=$db->Record["url"]."|";}$FlashSlide.="var files='".rtrim($pic,"|")."'\n"."var links='".rtrim($links,"|")."'\n"."var texts=''\n"."document.write('<object classid=\"clsid:d27cdb6e-ae6d-11cf-96b8-444553540000\" codebase=\"http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0\" width=\"'+ swf_width +'\" height=\"'+ swf_height +'\">');\n"."document.write('<param name=\"movie\" value=\"".$web_dir."lib/FlashSlide/Style".$Style."/Flash.swf\"><param name=\"quality\" value=\"high\">');\n"."document.write('<param name=\"menu\" value=\"false\"><param name=wmode value=\"opaque\">');\n"."document.write('<param name=\"FlashVars\" value=\"bcastr_file='+files+'&bcastr_link='+links+'&bcastr_title='+texts+'\">');\n"."document.write('<embed src=\"".$web_dir."lib/FlashSlide/Style".$Style."/Flash.swf\" wmode=\"opaque\" FlashVars=\"bcastr_file='+files+'&bcastr_link='+links+'&bcastr_title='+texts+'&menu=\"false\"\" quality=\"high\" width=\"'+ swf_width +'\" height=\"'+ swf_height +'\" type=\"application/x-shockwave-flash\" pluginspage=\"http://www.macromedia.com/go/getflashplayer\" />'); document.write('</object>');\n"."</script>";break;}return $FlashSlide;}?>