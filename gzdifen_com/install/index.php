<?phpif ( function_exists( "date_default_timezone_set") ){date_default_timezone_set( "PRC");}@set_time_limit(0);//error_reporting(E_ALL);error_reporting(E_ALL || ~E_NOTICE);include_once "../data/config.php";$verMsg = '3.0.2';$s_lang = 'utf-8';$dfDbname = 'PHPCMS';$errmsg = '';$insLockfile = '../data/install_lock.txt';define('PHPCMSROOT',ereg_replace("[\\/]install",'',dirname(__FILE__)));header("Content-Type:text/html;charset=utf-8");require_once(PHPCMSROOT.'/install/install.inc.php');foreach(Array('_GET','_POST','_COOKIE') as $_request){	 foreach($$_request as $_k => $_v) ${$_k} = RunMagicQuotes($_v);}if( file_exists('../data/install_lock.txt') ){	exit(" 程序已运行安装，如果你确定要重新安装，请先从FTP中删除 data/install_lock.txt！");}if(empty($step)){	$step = 1;}/*------------------------使用协议书function _1_Agreement()------------------------*/if($step==1){	include('./templates/step-1.html');	exit();}/*------------------------环境测试function _2_TestEnv()------------------------*/else if($step==2){	 $phpv = phpversion();	 $sp_os = @getenv('OS');	 $sp_gd = gdversion();	 $sp_server = $_SERVER['SERVER_SOFTWARE'];	 $sp_host = (empty($_SERVER['REMOTE_ADDR']) ? $_SERVER['REMOTE_HOST'] : $_SERVER['REMOTE_ADDR']);	 $sp_name = $_SERVER['SERVER_NAME'];	 $sp_max_execution_time = ini_get('max_execution_time');	 if (substr(PHP_VERSION, 0, 1) == '5') {            $sp_php_version= "<font color=#0588c1>[√]".phpversion()."</font>";         } else {			$sp_php_version= "<font color=red>[×]Off</font>" ;         } 	 $sp_allow_reference = (ini_get('allow_call_time_pass_reference') ? '<font color=#0588c1>[√]On</font>' : '<font color=red>[×]Off</font>');     $preg_replace = (ini_get('preg_replace') ? '<font color=red>[×]Off</font>' : '<font color=#0588c1>[√]On</font>');     $sp_gd = ($sp_gd>0 ? '<font color=#0588c1>[√]On</font>' : '<font color=red>[×]Off</font>');     $sp_mysql = (function_exists('mysql_connect') ? '<font color=#0588c1>[√]On</font>' : '<font color=red>[×]Off</font>');   if($sp_mysql=='<font color=red>[×]Off</font>')   {   		$sp_mysql_err = true;   }   else   {   		$sp_mysql_err = false;   }   $sp_testdirs = array(        '/',		'/admin/backup/*',        '/data/*',		'/lib/*',        '/templates/*',        '/upload/*',		        '/install',           );	 include('./templates/step-2.html');	 exit();}/*------------------------设置参数function _3_WriteSeting()------------------------*/else if($step==3){  if(!empty($_SERVER['REQUEST_URI']))  {  	$scriptName = $_SERVER['REQUEST_URI'];  }  else  {  	$scriptName = $_SERVER['PHP_SELF'];  }  $basepath = eregi_replace('/install(.*)$','',$scriptName)."/";  if(empty($_SERVER['HTTP_HOST']))  {  	$baseurl = 'http://'.$_SERVER['HTTP_HOST'];  }  else  {  	$baseurl = "http://".$_SERVER['SERVER_NAME'];  }  include('./templates/step-3.html');  exit();}/*------------------------普通安装function _4_Setup()------------------------*/else if($step==4){	function randstr($len=6) {$chars='abcdefghijklmnopqrstuvwxyz0123456789';mt_srand((double)microtime()*1000000*getmypid());$password='';while(strlen($password)<$len) $password.=substr($chars,(mt_rand()%strlen($chars)),1);return $password;}  function install($step)  {	  global $dbhost,$dbuser,$dbpwd,$dbname,$dbprefix,$verMsg,$conn,$baseurl,$webname,$cmspath,$adminuser,$name,$adminpwd,$insLockfile;	  $conn = @mysql_connect($dbhost,$dbuser,$dbpwd) ;      @mysql_query("SET NAMES utf8");          @mysql_query("CREATE DATABASE IF NOT EXISTS `".$dbname."`;",$conn);      @mysql_select_db($dbname);	  switch ($step)      {		  case 1 :  $scale='0.1';  $text='创建数据表';  $conn = mysql_connect($dbhost,$dbuser,$dbpwd) or die("<script>alert('数据库服务器或登录密码无效，\\n\\n无法连接数据库，请重新设定！');history.go(-1);</script>");  mysql_query("SET NAMES utf8");      mysql_query("CREATE DATABASE IF NOT EXISTS `".$dbname."`;",$conn);  mysql_select_db($dbname) or die("<script>alert('选择数据库失败，可能是你没权限，请预先创建一个数据库！');history.go(-1);</script>");break;case 2 :   $scale='0.2';	$text='配置系统文件';  $fp = fopen(dirname(__FILE__)."/data/config.txt","r");  $configStr1 = fread($fp,filesize(dirname(__FILE__)."/data/config.txt"));  fclose($fp);  //config.txt    $configStr1 = str_replace("~dbhost~",$dbhost,$configStr1);	$configStr1 = str_replace("~dbname~",$dbname,$configStr1);	$configStr1 = str_replace("~dbuser~",$dbuser,$configStr1);	$configStr1 = str_replace("~dbpwd~",$dbpwd,$configStr1);	$configStr1 = str_replace("~dbprefix~",$dbprefix,$configStr1);    $configStr1 = str_replace("~version~",$verMsg,$configStr1);  @chmod(PHPCMSROOT.'/data',0777);    $fp = fopen(PHPCMSROOT."/data/config.php","w") or die("<script>alert('写入配置失败，请检查../data目录是否可写入！');history.go(-1);</script>");  fwrite($fp,$configStr1);  fclose($fp);break;case 3 :  //创建数据表  $scale='0.3';  $text='安装系统数据库';  $query = '';  $fp = fopen(dirname(__FILE__).'/data/mysql_create.txt','r');	while(!feof($fp))	{		$query.=str_replace('#@__',$dbprefix,fgets($fp));	}        $arr = preg_split("/PHPCMScmsmysqlinstall/",$query,-1,PREG_SPLIT_NO_EMPTY);             foreach($arr as $path){                          mysql_query($path,$conn);              } fclose($fp);break;         case 4 :    $scale='0.4';	$text='更新网站配置';	//更新配置	$cquery = "INSERT INTO `{$dbprefix}config` (`id` ,`web_url` ,`web_name` ,`web_logo` ,`web_keywords` ,`web_description` ,`editor_style` ,`address` ,`tel` ,`icp` ,`web_html_mode` ,`skin_dir` ,`skin_cache` ,`web_html_dir` ,`web_html_name` ,`web_dir` ,`upfile` )VALUES (NULL ,  '{$baseurl}',  '{$webname}', NULL , NULL ,  'PHPCMS企业网站管理系统是一套针对企业开发的CMS。它是一款具有专业级的功能和傻瓜式管理的网站站管理...	',  'admin/themes/default/style.css',  '', NULL , NULL , 'php',  'default',  '1800',  'html/',  '1',  '{$cmspath}',  'upload/');";	mysql_query($cquery,$conn);break;case 5 :include_once "../lib/public.php";	//增加管理员帐号	$scale='0.5';	$text='添加超级管理员账号';		$salt=randstr();	$password=md5(md5($adminpwd).$salt);	$ip=getIP();	$time=time();	$adminquery = "INSERT INTO `{$dbprefix}admin` (`id`, `hits`, `user`, `name`, `password`, `salt`, `permissions`, `lasttime`, `ip`, `lastip`) VALUES(NULL, '1', '$adminuser', '$name', '$password', '$salt', 'a:14:{i:0;s:7:\"content\";i:1;s:4:\"html\";i:2;s:13:\"configuration\";i:3;s:7:\"columns\";i:4;s:6:\"slides\";i:5;s:5:\"links\";i:6;s:3:\"log\";i:7;s:3:\"sql\";i:8;s:5:\"cache\";i:9;s:5:\"admin\";i:10;s:4:\"skin\";i:11;s:9:\"templates\";i:12;s:6:\"module\";i:13;s:6:\"upload\";}', $time, '$ip', '$ip');";	mysql_query($adminquery,$conn);    mysql_close($conn);break;case 6 :  	//内容模块数据库	$scale='0.6';	$text='安装内容模块数据库';	  $query = '';     $fp = fopen(dirname(__FILE__).'/data/mysql_module.txt','r');	while(!feof($fp))	{		$query.=str_replace('#@__',$dbprefix,fgets($fp));	}        $arr = preg_split("/PHPCMScmsmysqlinstall/",$query,-1,PREG_SPLIT_NO_EMPTY);             foreach($arr as $path){                          mysql_query($path,$conn);              } fclose($fp);      	break;case 7 ://../lib/module.php  $scale='0.7';  $text='安装内容模块';  $fp = fopen(dirname(__FILE__)."/data/module.txt","r");  $content = fread($fp,filesize(dirname(__FILE__)."/data/module.txt"));  fclose($fp);  @chmod(PHPCMSROOT.'/lib',0777);    $fp = fopen(PHPCMSROOT."/lib/module.php","w") or die("<script>alert('写入配置失败，请检查../lib目录是否可写入！');history.go(-1);</script>");  fwrite($fp,$content);  fclose($fp);break;case 8 ://../view.php    $scale='0.8';	$text='配置内容模块';$fp = fopen(dirname(__FILE__)."/data/view.txt","r");  $content = fread($fp,filesize(dirname(__FILE__)."/data/view.txt"));  fclose($fp);  @chmod(PHPCMSROOT.'/lib',0777);    $fp = fopen(PHPCMSROOT."/view.php","w") or die("<script>alert('写入配置失败，请检查根目录是否可写入！');history.go(-1);</script>");  fwrite($fp,$content);  fclose($fp);break;case 9 :  	//测试内容	$scale='0.90';	$text='安装测试数据';	  $query = '';    $fp = fopen(dirname(__FILE__).'/data/mysql_demo.txt','r');	while(!feof($fp))	{		$query.=str_replace('#@__',$dbprefix,fgets($fp));	}        $arr = preg_split("/PHPCMScmsmysqlinstall/",$query,-1,PREG_SPLIT_NO_EMPTY);             foreach($arr as $path){                          mysql_query($path,$conn);              } fclose($fp);  	break;case 10 :  	//锁定安装程序	$scale='1';	$text='安装完成';  	break;	  }echo '<script language="JavaScript">document.getElementById("RefreshLenx").style.width = ('.$scale.')*100+"%";document.getElementById("RefreshLenx").innerHTML = ('.$scale.')*100+"%";document.getElementById("text").innerHTML = "'.$text.'";classhtml(Url);</script>';}  	include('./templates/step-4.html');  	exit();}/*------------------------完成安装function _5_Setup()------------------------*/else if($step==5){	$fp = fopen($insLockfile,'w');  	fwrite($fp,'PHPCMS企业网站管理系统于'.date('Y-m-d H:i:s',time()).'安装成功！http://www.gzcgc.net');  	fclose($fp);	include('./templates/step-5.html');	  	exit();}/*------------------------检测数据库是否有效function _10_TestDbPwd()------------------------*/else if($step==10){	header("Pragma:no-cache\r\n");  header("Cache-Control:no-cache\r\n");  header("Expires:0\r\n");	$conn = @mysql_connect($dbhost,$dbuser,$dbpwd);	if($conn)	{	  $rs = mysql_select_db($dbname,$conn);	  if(!$rs)	  {		   $rs = mysql_query(" CREATE DATABASE `$dbname`; ",$conn);		   if($rs)		   {		  	  mysql_query(" DROP DATABASE `$dbname`; ",$conn);		  	  echo "<font color='#0588c1'>信息正确</font>";		   }		   else		   {		      echo "<font color='red'>数据库不存在，也没权限创建新的数据库！</font>";		   }	  }	  else	  {		    echo "<font color='#0588c1'>信息正确</font>";	  }	}	else	{		echo "<font color='red'>数据库连接失败！</font>";	}	@mysql_close($conn);	exit();}?>