<?phprequire_once(dirname(__FILE__).'/header.php');$ids = is_numeric($_GET['id']) ? array($_GET['id']) : $_POST['id'];if(isset($action)){	if($action=='googlemap')	{		$systemdb[]='article';		set_time_limit(0);		index_map($systemdb);			system_map();				msgbox("生成完毕","BACK");	}	elseif($action=='baidumap')	{		set_time_limit(0);		baidu_map();	msgbox("生成完毕","BACK");	}}function index_map($array){	global $webdb,$config;	foreach( $array AS $key=>$value){		$showdb[]="<sitemap>\r\n<loc>".$config['url']."GoogleMap_$value.xml</loc>\r\n</sitemap>";	}	$show='<?xml version="1.0" encoding="GB2312"?>'."\r\n";	$show.='<sitemapindex xmlns="http://www.google.com/schemas/sitemap/0.84">'."\r\n";	$show.=implode("\r\n",$showdb);	$show.="\r\n".'</sitemapindex>'."\r\n";	write_file(CMSROOT."/sitemap.xml",$show);}function system_map(){	global $db,$DB,$lang,$config;	$query = $db->query("SELECT id,addtime FROM {$DB['prefix']}article WHERE audit=1 AND lang=".$lang." ORDER BY id DESC LIMIT 1000");	foreach($query as &$rs){			$showdb[]="<url>\r\n<loc>".$config['url']."view.php?id=".$rs["id"]."</loc>\r\n<lastmod>". date('Y-m-d H:i:s',$rs["addtime"])."</lastmod>\r\n<changefreq>daily</changefreq>\r\n<priority>1.0</priority>\r\n</url>";	}	$show='<?xml version="1.0" encoding="utf-8"?>'."\r\n";	$show.='<urlset xmlns="http://www.google.com/schemas/sitemap/0.84">'."\r\n";	$show.=implode("\r\n",$showdb);	$show.="\r\n".'</urlset>'."\r\n";	write_file(CMSROOT."/GoogleMap_article.xml",$show);}function replace_url($url){	$url=str_replace("&","&amp;",$url);	$url=str_replace("'","&apos;",$url);	$url=str_replace("\"","&quot;",$url);	$url=str_replace("\"","&quot;",$url);	$url=str_replace(">","&gt;",$url);	$url=str_replace("<","&lt;",$url);	return $url;}function baidu_map(){	global $db,$DB,$lang,$config;	$query = $db->query("SELECT * FROM {$DB['prefix']}article WHERE audit=1 AND lang=".$lang." ORDER BY id DESC LIMIT 100");	foreach($query as &$rs){				$time=date("Y-m-d H:i:s",$rs[addtime]);		$content=get_word(preg_replace("/(<([^<]+)>|	|&nbsp;|\n)/is","",$rs["content"]),200);		$content=str_replace(array(">","<"),array("",""),$content);		$content=str_replace(array("\\s*","\t","\r","\n"),array("","","",""),$content);		$showdb[]="<item>\r\n<link>".$config['url']."view.php?id=".$rs["id"]."</link>\r\n<title>".$rs["title"]."</title>\r\n<text>$content</text>\r\n<image>".$rs["picture"]."</image>\r\n<category>".$rs["title"]."</category>\r\n<pubDate>".$time."</pubDate>\r\n</item>\r\n";	}	$show='<?xml version="1.0" encoding="utf-8"?>'."\r\n";	$show.='<document>'."\r\n";	$show.="<webSite>".$config['url']."/</webSite>"."\r\n";	$show.="<webMaster>".$config['email']."</webMaster>"."\r\n";	$show.="<updatePeri>1440</updatePeri>"."\r\n";	$show.=implode("\r\n",$showdb);	$show.="\r\n".'</document>'."\r\n";	write_file(CMSROOT."/baidu_MAP.xml",$show);}function write_file($filename,$data,$method="rb+",$iflock=1){	@touch($filename);	$handle=@fopen($filename,$method);	if($iflock){		@flock($handle,LOCK_EX);	}	@fputs($handle,$data);	if($method=="rb+") @ftruncate($handle,strlen($data));	@fclose($handle);	@chmod($filename,0777);		if( is_writable($filename) ){		return 1;	}else{		return 0;	}}/***截取字符**/function get_word($content,$length,$more=1) {	if(WEB_LANG=='utf-8'){		$content = get_utf8_word($content, $length,$more);		return $content;	}	if(WEB_LANG=='big5'){		$more=1;	//不这样的话.截取字符容易使用页面乱码	}	if(!$more){		$length=$length+2;	}	if($length>10){		$length=$length-2;	}	if($length && strlen($content)>$length){		$num=0;		for($i=0;$i<$length-1;$i++) {			if(ord($content[$i])>127){				$num++;			}		}		$num%2==1 ? $content=substr($content,0,$length-2):$content=substr($content,0,$length-1);		$more && $content.='..';	}	return $content;}require_once(ADMIN_PATH.'/footer.php'); 