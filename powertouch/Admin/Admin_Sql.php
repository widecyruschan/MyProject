<?phpinclude( "inc/header.php" );login_check(); $MAX_ROWS_PER_PAGE=50;  $D="\r\n";  $self=$_SERVER['PHP_SELF']; session_start(); ini_set('display_errors',0);// error_reporting(E_ALL ^ E_NOTICE);//strip quotes if they set if (get_magic_quotes_gpc()){  $_COOKIE=array_map('killmq',$_COOKIE);  $_REQUEST=array_map('killmq',$_REQUEST); } loadsess(); //get initial values $SQLq=trim($_REQUEST['q']); $page=$_REQUEST['p']+0; if ($_REQUEST['refresh'] && $DB['db'] && !$SQLq) $SQLq="show tables";    $time_start=microtime_float();       if ($_REQUEST['phpinfo']){       ob_start();phpinfo();$sqldr=ob_get_clean();    }else{     if ($DB['db']){      if ($_REQUEST['shex']){       print_export();      }elseif ($_REQUEST['doex']){       do_export();      }elseif ($_REQUEST['shim']){       print_import();      }elseif ($_REQUEST['doim']){       do_import();      }elseif ($_REQUEST['dosht']){       do_sht();      }elseif (!$_REQUEST['refresh'] || preg_match('/^select|show|explain|desc/i',$SQLq) ) do_sql($SQLq);#perform non-selet SQL only if not refresh (to avoid dangerous delete/drop)     }else{        if ( $_REQUEST['refresh'] ){			addlog( "对数据库进行查询", $_SESSION['user_name'] );           do_sql('show databases');        }elseif ( preg_match('/^show\s+(?:databases|status|variables)/i',$SQLq) ){           do_sql($SQLq);        }else{           $err_msg="请选择一个数据库";        }     }    }    $time_all=ceil((microtime_float()-$time_start)*10000)/10000;       print_screen();function do_sql($q){ global $dbh,$last_sth,$last_sql,$reccount,$out_message,$SQLq; $SQLq=$q; if (!do_multi_sql($q,'',1)){    $out_message="错误: ".mysql_error($dbh); }else{    if ($last_sth && $last_sql){       $SQLq=$last_sql;       if (preg_match("/^select|show|explain|desc/i",$last_sql)) {          if ($q!=$last_sql) $out_message="最后选择显示的结果:";          display_select($last_sth,$last_sql);       } else {         $reccount=mysql_affected_rows($dbh);         $out_message="完成.";         if (preg_match("/^insert|replace/i",$last_sql)) $out_message.=" 最后插入 id=".get_identity();         if (preg_match("/^drop|truncate/i",$last_sql)) do_sql("show tables");       }    } }}function display_select($sth,$q){ global $dbh,$DB,$sqldr,$reccount,$is_sht; $rc=array("o","e"); $dbn=$DB['db']; $sqldr=''; $is_shd=(preg_match('/^show databases/i',$q)); $is_sht=(preg_match('/^show tables/i',$q)); $is_show_crt=(preg_match('/^show create table/i',$q)); $reccount=mysql_num_rows($sth); $fields_num=mysql_num_fields($sth);  $w="width='100%' "; if ($is_sht || $is_shd) {$w='';   $sqldr.="</td></tr></table><br/><table width=\"98%\" border=\"1\" align=\"center\" cellpadding=\"5\" cellspacing=\"0\" class=\"table\" style=\"margin-top:10px\"><tr><td>   <div class='dot'>&nbsp;<strong>全局:</strong>&nbsp;&#183;<a href='?db=$dbn&q=show+variables'>变量</a>&nbsp;&#183;<a href='?db=$dbn&q=show+status'>结构</a>&nbsp;&#183;<a href='?db=$dbn&q=show+processlist'>进程</a> 　　　　　　　　　　";   if ($is_sht) $sqldr.="&nbsp;<strong>当前:</strong>&nbsp;  &#183;<a href='?db=$dbn&q=show+table+status'>结构</a>";   $sqldr.="</div>"; } if ($is_sht){   $abtn="<span style=\"float:right;\"><b>执行</b>&nbsp;<input type='submit' value='备份' onclick=\"sht('exp')\"> <input type='submit' value='删除' onclick=\"if(ays()){sht('drop')}else{return false}\"> <input type='submit' value='清空' onclick=\"if(ays()){sht('tunc')}else{return false}\"> <input type='submit' value='优化' onclick=\"sht('opt')\"></span> ";   $sqldr.=$abtn."<input type='hidden' name='dosht' value=''>"; } $sqldr.="<table align='center' width='100%' cellpadding='5' cellspacing='0' class='table' >"; $headers="<tr class='h' style='line-height:25px;background:#ccc; text-align:center;'>"; if ($is_sht) $headers.="<td align=left><input type='checkbox' name='cball' value='' onclick='chkall(this)'></td>"; for($i=0;$i<$fields_num;$i++){    $meta=mysql_fetch_field($sth,$i);    $headers.="<td>".$meta->name."</td>"; } if ($is_shd) $headers.="<td>结构</td><td>状态</td><td>触发</td>"; if ($is_sht) $headers.="<td>结构</td><td>注释</td><td>索引</td><td>备份</td><td>删除</td><td>清空</td><td>优化</td><td>修复</td>"; $headers.="</tr>\n"; $sqldr.=$headers; $swapper=false; while($row=mysql_fetch_row($sth)){   $sqldr.="<tr class='".$rc[$swp=!$swp]."' onmouseover='tmv(this)' onmouseout='tmo(this)' onclick='tc(this)'>";   for($i=0;$i<$fields_num;$i++){      $v=$row[$i];$more='';      if ($is_sht && $i==0 && $v){         $vq='`'.$v.'`';         $v="<input type='checkbox' name='cb[]' value=\"$vq\"></td>"         ."<td align=\"center\"><a href=\"?db=$dbn&q=select+*+from+$vq\">$v</a></td>"         ."<td align=\"center\"><a href=\"?db=$dbn&q=show+create+table+$vq\">sct</a></td>"         ."<td align=\"center\"><a href=\"?db=$dbn&q=explain+$vq\">exp</a></td>"         ."<td align=\"center\"><a href=\"?db=$dbn&q=show+index+from+$vq\">ind</a></td>"         ."<td align=\"center\"><a href=\"?db=$dbn&shex=1&t=$vq\">export</a></td>"         ."<td align=\"center\"><a href=\"?db=$dbn&q=drop+table+$vq\" onclick='return ays()'>dr</a></td>"         ."<td align=\"center\"><a href=\"?db=$dbn&q=truncate+table+$vq\" onclick='return ays()'>tr</a></td>"         ."<td align=\"center\"><a href=\"?db=$dbn&q=optimize+table+$vq\" onclick='return ays()'>opt</a></td>"         ."<td align=\"center\"><a href=\"?db=$dbn&q=repair+table+$vq\" onclick='return ays()'>rpr</a>";      }elseif ($is_shd && $i==0 && $v){         $v="<a href=\"?db=$v&q=show+tables\">$v</a></td>"         ."<td align=\"center\"><a href=\"?db=$v&q=show+create+database+`$v`\">sct</a></td>"         ."<td align=\"center\"><a href=\"?db=$v&q=show+table+status\">status</a></td>"         ."<td align=\"center\"><a href=\"?db=$v&q=show+triggers\">trig</a></td>"         ;      }else{       if (is_null($v)) $v="NULL";       $v=htmlspecialchars($v);      }      if ($is_show_crt) $v="<pre>$v</pre>";      $sqldr.="<td>$v".(!strlen($v)?"<br />":'')."</td>";   }   $sqldr.="</tr>\n"; } $sqldr.="</table>\n".$abtn;}function print_header(){ global $err_msg,$DB,$dbh,$self,$is_sht; $dbn=$DB['db'];?><style type="text/css">body{font-family:Arial,Helvetica,sans-serif;font-size:12px;padding:0px;margin:0px}div{padding:3px}.inv{background-color:#F7F7F7;color:#FFFFFF}.inv a{color:#FFFFFF}table.res th, table.res td{padding:2px}table.res tr{vertical-align:top}tr.e{background-color:#F9F9F9}tr.o{background-color:#EEEEEE}tr.h{background-color:#eff7f7}.err{color:#FF3333;font-weight:bold;text-align:center}.frm{width:400px;border:1px solid #999999;background-color:#eeeeee;text-align:left; margin-bottom:30px;}</style><script type="text/javascript">function $(i){return document.getElementById(i)}function frefresh(){ var F=document.DF; F.method='get'; F.refresh.value="1"; F.submit();}function go(p,sql){ var F=document.DF; F.p.value=p; if(sql)F.q.value=sql; F.submit();}function ays(){ return confirm('你确定这样做?');}function chksql(){ var F=document.DF; if(/^\s*(?:delete|drop|truncate|alter)/.test(F.q.value)) return ays();}function tmv(tr){ tr.sc=tr.className; tr.className='h';}function tmo(tr){ tr.className=tr.sc;}function tc(tr){ tr.className='s'; tr.sc='s';}function after_load(){}<?php if($is_sht){?>function chkall(cab){ var e=document.DF.elements; if (e!=null){  var cl=e.length;                     for (i=0;i<cl;i++){var m=e[i];if(m.checked!=null && m.type=="checkbox"){m.checked=cab.checked}} }}function sht(f){ document.DF.dosht.value=f;}<?php }?></script></head><body onLoad="after_load()"><form method="post" name="DF" action="<?php echo $self?>" enctype="multipart/form-data"><input type="hidden" name="refresh" value=""><input type="hidden" name="p" value=""><table width="98%" border="1" align="center" cellpadding="5" cellspacing="0" class="table" style="margin-top:10px"><tr><td style="line-height:35px; text-indent:20px;"><span style="float:right; margin-right:20px;"><a href="Admin_Sql2.php">旧版</a></span><a href="?q=show+databases">当前数据库</a>: <select name="db" onChange="frefresh()"><option value='*'> - 选择 -</option><option value=''> - 全部数据库 -</option><?php echo get_db_select($dbn)?></select><?php if($dbn){ $z=" &#183;<a href='$self?db=$dbn"; ?><?php echo $z?>&q=show+tables'>打开数据库</a><?php echo $z?>&q=show+table+status'>结构</a><?php echo $z?>&shex=1'>备份</a><?php echo $z?>&shim=1'>还原</a><?php } ?></td></tr></table><br/><table width="98%" border="1" align="center" cellpadding="5" cellspacing="0" class="table"><tr><td><div class="inv"></div><div class="err"><?php echo $err_msg?></div><?php}function print_screen(){ global $out_message, $SQLq, $err_msg, $reccount, $time_all, $sqldr, $page, $MAX_ROWS_PER_PAGE, $is_limited_sql; print_header();?><div class="dot" style="padding:0 0 5px 20px">SQL查询 (通过使用";"符号，可以执行多条数据):<br /><textarea name="q" cols="70" rows="10" style="width:98%"><?php echo $SQLq?></textarea><br/><input type=submit name="GoSQL" value="执行" onClick="return chksql()" style="width:100px">&nbsp;&nbsp;<input type=button name="Clear" value="重置" onClick="document.DF.q.value=''" style="width:100px"></div><div class="dot" style="padding:5px 0 5px 20px">记录: <b><?php echo $reccount?></b>条 耗时： <b><?php echo $time_all?></b> 秒<br /><b><?php echo $out_message?></b></div><?php if ($is_limited_sql && ($page || $reccount>=$MAX_ROWS_PER_PAGE) ){  echo "<center>".make_List_Navigation($page, 10000, $MAX_ROWS_PER_PAGE, "javascript:go(%p%)")."</center>"; }#$reccount?><?php echo $sqldr?><?php print_footer();}function print_footer(){?></form></body></html><?php}//* utilitiesfunction db_connect($nodie=0){ global $dbh,$DB,$err_msg,$DB_Host,$DB_User,$DB_Password; $dbh=@mysql_connect($DB_Host,$DB_User,$DB_Password); if (!$dbh) {    $err_msg='无法连接到数据库，因为: '.mysql_error();    if (!$nodie) die($err_msg); }$DB['chset']="utf8"; if ($dbh && $DB['db']) {  $res=mysql_select_db($DB['db'], $dbh);    if (!$res) {     $err_msg='Cannot select db because: '.mysql_error();     if (!$nodie) die($err_msg);  }else{     if ($DB['chset']) db_query("SET NAMES ".$DB['chset']);  } } return $dbh;}function db_checkconnect($dbh1=NULL, $skiperr=0){ global $dbh; if (!$dbh1) $dbh1=&$dbh; if (!$dbh1 or !mysql_ping($dbh1)) {    db_connect($skiperr);    $dbh1=&$dbh; } return $dbh1;}function db_disconnect(){ global $dbh; mysql_close($dbh);}function dbq($s){ global $dbh; if (is_null($s)) return "NULL"; return "'".mysql_real_escape_string($s,$dbh)."'";}function db_query($sql, $dbh1=NULL, $skiperr=0){ $dbh1=db_checkconnect($dbh1, $skiperr); $sth=@mysql_query($sql, $dbh1); if (!$sth && $skiperr) return; catch_db_err($dbh1, $sth, $sql); return $sth;}function db_array($sql, $dbh1=NULL, $skiperr=0, $isnum=0){#array of rows $sth=db_query($sql, $dbh1, $skiperr); if (!$sth) return; $res=array(); if ($isnum){   while($row=mysql_fetch_row($sth)) $res[]=$row; }else{   while($row=mysql_fetch_assoc($sth)) $res[]=$row; } return $res;}function catch_db_err($dbh, $sth, $sql=""){ if (!$sth) die("Error in DB operation:<br/>\n".mysql_error($dbh)."<br/>\n$sql");}function get_identity($dbh1=NULL){ $dbh1=db_checkconnect($dbh1); return mysql_insert_id($dbh1);}function get_db_select($sel=''){ global $DB; $result=''; if ($_SESSION['sql_sd'] && !$_REQUEST['db']=='*'){//check cache    $arr=$_SESSION['sql_sd']; }else{   $arr=db_array("show databases",NULL,1);   if (!$arr){      $arr=array( 0 => array('Database' => $DB['db']) );    }   $_SESSION['sql_sd']=$arr; } return @sel($arr,'Database',$sel);}function chset_select($sel=''){ $result=''; if ($_SESSION['sql_chset']){    $arr=$_SESSION['sql_chset']; }else{   $arr=db_array("show character set",NULL,1);   $_SESSION['sql_chset']=$arr; } return @sel($arr,'Charset',$sel);}function sel($arr,$n,$sel=''){ foreach($arr as $a){   echo $a[0];#???   $b=$a[$n];   $res.="<option value='$b' ".($sel && $sel==$b?'selected':'').">$b</option>"; } return $res;}function microtime_float(){ list($usec,$sec)=explode(" ",microtime());  return ((float)$usec+(float)$sec); } ############################# $pg=int($_[0]);     #current page# $all=int($_[1]);     #total number of items# $PP=$_[2];      #number if items Per Page# $ptpl=$_[3];      #page url /ukr/dollar/notes.php?page=    for notes.php# $show_all=$_[5];           #print Totals?function make_List_Navigation($pg, $all, $PP, $ptpl, $show_all=''){  $n='&nbsp;';  $sep=" $n|$n\n";  if (!$PP) $PP=10;  $allp=floor($all/$PP+0.999999);  $pname='';  $res='';  $w=array('Less','More','Back','Next','First','Total');  $sp=$pg-2;  if($sp<0) $sp=0;  if($allp-$sp<5 && $allp>=5) $sp=$allp-5;  $res="";  if($sp>0){    $pname=pen($sp-1,$ptpl);    $res.="<a href='$pname'>$w[0]</a>";           $res.=$sep;  }  for($p_p=$sp;$p_p<$allp && $p_p<$sp+5;$p_p++){     $first_s=$p_p*$PP+1;     $last_s=($p_p+1)*$PP;     $pname=pen($p_p,$ptpl);     if($last_s>$all){       $last_s=$all;     }           if($p_p==$pg){        $res.="<b>$first_s..$last_s</b>";     }else{        $res.="<a href='$pname'>$first_s..$last_s</a>";     }            if($p_p+1<$allp) $res.=$sep;  }  if($sp+5<$allp){    $pname=pen($sp+5,$ptpl);    $res.="<a href='$pname'>$w[1]</a>";         }  $res.=" <br/>\n";  if($pg>0){    $pname=pen($pg-1,$ptpl);    $res.="<a href='$pname'>$w[2]</a> $n|$n ";    $pname=pen(0,$ptpl);    $res.="<a href='$pname'>$w[4]</a>";     }  if($pg>0 && $pg+1<$allp) $res.=$sep;  if($pg+1<$allp){    $pname=pen($pg+1,$ptpl);    $res.="<a href='$pname'>$w[3]</a>";      }      if ($show_all) $res.=" <b>($w[5] - $all)</b> ";  return $res;}function pen($p,$np=''){ return str_replace('%p%',$p, $np);}function killmq($value){ return is_array($value)?array_map('killmq',$value):stripslashes($value);}function savecfg(){ $v=$_REQUEST['v']; $_SESSION['DB']=$v; unset($_SESSION['sql_sd']); if ($_REQUEST['rmb']){    $tm=time()+60*60*24*30;    setcookie("conn[db]",  $v['db'],$tm);    setcookie("conn[user]",$v['user'],$tm);    setcookie("conn[pwd]", $v['pwd'],$tm);    setcookie("conn[host]",$v['host'],$tm);    setcookie("conn[port]",$v['port'],$tm);    setcookie("conn[chset]",$v['chset'],$tm); }else{    setcookie("conn[db]",  FALSE,-1);    setcookie("conn[user]",FALSE,-1);    setcookie("conn[pwd]", FALSE,-1);    setcookie("conn[host]",FALSE,-1);    setcookie("conn[port]",FALSE,-1);    setcookie("conn[chset]",FALSE,-1); }}//each time - from session to $DB_*function loadsess(){ global $DB; $DB=$_SESSION['DB']; $rdb=$_REQUEST['db']; if ($rdb=='*') $rdb=''; if ($rdb) {    $DB['db']=$rdb; }}function print_export(){ global $self; $t=$_REQUEST['t']; $l=($t)?"Table $t":"整个数据库"; print_header();?><center><h3>还原 <?php echo $l?></h3><div class="frm"><input type="checkbox" name="s" value="1" checked> 包含结构<br /><input type="checkbox" name="d" value="1" checked> 包含数据内容<br /><br /><input type="radio" name="et" value="" checked> 导出为sql格式<br /> <input type="radio" name="et" value="csv"> 导出为CSV格式)<br /><br /><input type="hidden" name="doex" value="1"><input type="hidden" name="t" value="<?php echo $t?>"><input type="submit" value="下载"><input type="button" value="取消" onClick="window.location='<?php echo $self?>'"></div></center><?php print_footer(); exit;}function do_export(){ global $DB,$VERSION,$D; $rt=$_REQUEST['t']; $t=split(",",$rt); $th=array_flip($t); $ct=count($t); $z=db_array("show variables like 'max_allowed_packet'"); $MAXI=floor($z[0]['Value']*0.8); if(!$MAXI)$MAXI=838860; if ($ct==1&&$_REQUEST['et']=='csv'){  @header('Content-type: text/csv');  @header("Content-Disposition: attachment; filename=\"$t[0].csv\"");  $sth=db_query("select * from `$t[0]`");  $fn=mysql_num_fields($sth);  for($i=0;$i<$fn;$i++){   $m=mysql_fetch_field($sth,$i);   echo qstr($m->name).(($i<$fn-1)?",":"");  }  echo "\n";  while($row=mysql_fetch_row($sth)){   echo to_csv_row($row);  }  exit; } @header('Content-type: text/plain'); @header("Content-Disposition: attachment; filename=\"$DB[db]".(($ct==1&&$t[0])?".$t[0]":(($ct>1)?'.'.$ct.'tables':'')).".sql\""); echo "-- Datetime: ".date('Y-m-d H:i:s')."$D-- Host: $DB[host]$D-- Database: $DB[db]$D$D"; echo "/*!40030 SET NAMES $DB[chset] */;$D/*!40030 SET GLOBAL max_allowed_packet=16777216 */;$D$D"; $sth=db_query("show tables from `$DB[db]`"); while($row=mysql_fetch_row($sth)){   if (!$rt||array_key_exists($row[0],$th)) do_export_table($row[0],1,$MAXI); } echo "$D-- phpMiniAdmin dump end$D"; exit;}function do_export_table($t='',$isvar=0,$MAXI=838860){ global $D; set_time_limit(600); if($_REQUEST['s']){  $sth=db_query("show create table `$t`");  $row=mysql_fetch_row($sth);  echo "DROP TABLE IF EXISTS `$t`;\n$row[1];$D$D"; } if ($_REQUEST['d']){  $exsql='';  echo "/*!40000 ALTER TABLE `$t` DISABLE KEYS */;$D";  $sth=db_query("select * from `$t`");  while($row=mysql_fetch_row($sth)){    $values='';    foreach($row as $v) $values.=(($values)?',':'').dbq($v);    $exsql.=(($exsql)?',':'')."(".$values.")";    if (strlen($exsql)>$MAXI) {       echo "INSERT INTO `$t` VALUES $exsql;$D";$exsql='';    }  }  if ($exsql) echo "INSERT INTO `$t` VALUES $exsql;$D";  echo "/*!40000 ALTER TABLE `$t` ENABLE KEYS */;$D$D"; } flush();}function print_import(){ global $self; print_header();?><center><h3>使用.sql还原数据库</h3><div class="frm">.sql 文件: <input type="file" name="file1" value="" size=40><br /><input type="hidden" name="doim" value="1"><input type="submit" value="还原数据库" onClick="return ays()"><input type="button" value=" 取消 " onClick="window.location='<?php echo $self?>'"></div><br /><br /><br /><h3>使用.CSV还原数据库</h3><div class="frm">.csv 文件 (Excel表格): <input type="file" name="file2" value="" size=40><br /><input type="checkbox" name="r1" value="1" checked> 第一行需包含字段名称<br/><small>(注意: 字段名称应该是完全一样的数据库)</small><br />编码: <select name="chset"><?php echo chset_select('utf8')?></select><br/><br/>还原信息:<br/><input type="radio" name="tt" value="1" checked="checked"> 被换数据库: <select name="t"> <option value=''>- 选择 -</option> <?php echo sel(db_array('show tables',NULL,0,1), 0, ''); ?></select><div style="margin-left:20px"> <input type="checkbox" name="ttr" value="1"> 覆盖现有数据库<br /> <input type="checkbox" name="tti" value="1"> 忽略重复的行</div><input type="radio" name="tt" value="2"> 创建新表的名称 <input type="text" name="tn" value="" size="20"><br /><br /><input type="hidden" name="doimcsv" value="1"><input type="submit" value="还原数据库" onClick="return ays()"><input type="button" value="取消" onClick="window.location='<?php echo $self?>'"></div></center></td></tr></table><?php print_footer(); exit;}function do_import(){ global $err_msg,$out_message,$dbh; if ($_FILES['file1'] && $_FILES['file1']['name']){  $filename=$_FILES['file1']['tmp_name'];  if (!do_multi_sql('', $filename) ){     $err_msg="Error: ".mysql_error($dbh);  }else{     $out_message='成功还原数据库';     do_sql('show tables');     return;  } }else{  $err_msg="Error:请选择第一个文件"; } print_import(); exit;}// multiple SQL statements splitterfunction do_multi_sql($insql, $fname){ set_time_limit(600); $sql=''; $ochar=''; $is_cmt=''; $GLOBALS['insql_done']=0; while ( $str=get_next_chunk($insql, $fname) ){    $opos=-strlen($ochar);    $cur_pos=0;    $i=strlen($str);    while ($i--){       if ($ochar){          list($clchar, $clpos)=get_close_char($str, $opos+strlen($ochar), $ochar);          if ( $clchar ) {             if ($ochar=='--' || $ochar=='#' || $is_cmt ){                $sql.=substr($str, $cur_pos, $opos-$cur_pos );             }else{                $sql.=substr($str, $cur_pos, $clpos+strlen($clchar)-$cur_pos );             }             $cur_pos=$clpos+strlen($clchar);             $ochar='';             $opos=0;          }else{             $sql.=substr($str, $cur_pos);             break;          }       }else{          list($ochar, $opos)=get_open_char($str, $cur_pos);          if ($ochar==';'){             $sql.=substr($str, $cur_pos, $opos-$cur_pos+1);             if (!do_one_sql($sql)) return 0;             $sql='';             $cur_pos=$opos+strlen($ochar);             $ochar='';             $opos=0;          }elseif(!$ochar) {             $sql.=substr($str, $cur_pos);             break;          }else{             $is_cmt=0;if ($ochar=='/*' && substr($str, $opos, 3)!='/*!') $is_cmt=1;          }       }    } } if ($sql){    if (!do_one_sql($sql)) return 0;    $sql=''; } return 1;}//read from insql var or filefunction get_next_chunk($insql, $fname){ global $LFILE, $insql_done; if ($insql) {    if ($insql_done){       return '';    }else{       $insql_done=1;       return $insql;    } } if (!$fname) return ''; if (!$LFILE){    $LFILE=fopen($fname,"r+b") or die("Can't open [$fname] file $!"); } return fread($LFILE, 64*1024);}function get_open_char($str, $pos){ if ( preg_match("/(\/\*|^--|(?<=\s)--|#|'|\"|;)/", $str, $m, PREG_OFFSET_CAPTURE, $pos) ) {    $ochar=$m[1][0];    $opos=$m[1][1]; } return array($ochar, $opos);}#RECURSIVE!function get_close_char($str, $pos, $ochar){ $aCLOSE=array(   '\'' => '(?<!\\\\)\'|(\\\\+)\'',   '"' => '(?<!\\\\)"',   '/*' => '\*\/',   '#' => '[\r\n]+',   '--' => '[\r\n]+', ); if ( $aCLOSE[$ochar] && preg_match("/(".$aCLOSE[$ochar].")/", $str, $m, PREG_OFFSET_CAPTURE, $pos ) ) {    $clchar=$m[1][0];    $clpos=$m[1][1];    $sl=strlen($m[2][0]);    if ($ochar=="'" && $sl){       if ($sl % 2){ #don't count as CLOSE char if number of slashes before ' ODD          list($clchar, $clpos)=get_close_char($str, $clpos+strlen($clchar), $ochar);       }else{          $clpos+=strlen($clchar)-1;$clchar="'";#correction       }    } } return array($clchar, $clpos);}function do_one_sql($sql){ global $last_sth,$last_sql,$MAX_ROWS_PER_PAGE,$page,$is_limited_sql; $sql=trim($sql); $sql=preg_replace("/;$/","",$sql); if ($sql){    $last_sql=$sql;$is_limited_sql=0;    if (preg_match("/^select/i",$sql) && !preg_match("/limit +\d+/i", $sql)){       $offset=$page*$MAX_ROWS_PER_PAGE;       $sql.=" LIMIT $offset,$MAX_ROWS_PER_PAGE";       $is_limited_sql=1;    }    $last_sth=db_query($sql,0,'noerr');    return $last_sth; } return 1;}function do_sht(){ $cb=$_REQUEST['cb']; switch ($_REQUEST['dosht']){  case 'exp':$_REQUEST['t']=join(",",$cb);print_export();exit;  case 'drop':$sq='DROP TABLE';break;  case 'trunc':$sq='TRUNCATE TABLE';break;  case 'opt':$sq='OPTIMIZE TABLE';break; } if ($sq && is_array($cb)){  foreach($cb as $v){   $sql.=$sq." $v;\n";  }  do_sql($sql); } do_sql('show tables');}function to_csv_row($adata){ $r=''; foreach ($adata as $a){   $r.=(($r)?",":"").qstr($a); } return $r."\n";}function qstr($s){ $s=nl2br($s); $s=str_replace('"','""',$s); return '"'.$s.'"';}?>