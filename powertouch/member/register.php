<?phpinclude( "./inc/header.php" );session_start();if(empty($_POST['submit'])) {    	if($_GET['action'] == 'activation') {		echo '<form method="post" action="register.php">';		echo '激活:';		list($activeuser) = explode("\t", uc_authcode($_GET['auth'], 'DECODE'));		echo '<input type="hidden" name="activation" value="'.$activeuser.'">';		echo '<dl><dt>用户名</dt><dd>'.$activeuser.'</dd></dl>';		echo '<input name="submit" type="submit"> ';	echo '</form>';	} else {    //注册表单	$location=Location('register','');	define('IN' , true);	$tpl_refresh_time =  $skincache;	$tpl_default_dir =  "../templates/".$skindir."/member";	$t = new template;	$t->tpl_default_dir = $tpl_default_dir;	$t->tpl_refresh_time = $tpl_refresh_time;	include $t->tpl('register');	}} else {	if($uc_switch=="1"){	//在UCenter注册用户信息	$username = '';	if(!empty($_POST['activation']) && ($activeuser = uc_get_user($_POST['activation']))) {		list($uid, $username, $email) = $activeuser;	} else {		if(uc_get_user($_POST['username']) && !$db3->result_first("SELECT id FROM {$DB_dbprefix}member WHERE user='$_POST[username]'")) {		//判断需要注册的用户如果是需要激活的用户，则需跳转到登录页面验证		echo '<script language="javascript">alert("该用户无需注册，请激活该用户！");window.navigate("login.php");</script>';		exit;		} 		$uid = uc_user_register($_POST['username'], $_POST['password'], $_POST['email']);		if($uid <= 0) {			//验证码判断	           session_start();               if (strtoupper($_POST['vcode']) != $_SESSION['vcode']) {                  echo '<script language=javascript>alert(\'验证码错误，请重新输入!\');history.go(-1)</script>';			   unset ($_SESSION['vcode']);	           exit( );            } 			unset ($_SESSION['vcode']);						if($_POST['username'] == "") {				echo '<script language=javascript>alert(\'用户名不能为空\');history.go(-1)</script>';			} elseif($password == -1) {				echo '<script language=javascript>alert(\'用户名不合法\');history.go(-1)</script>';			} elseif($_POST['password']==""){				echo '<script language=javascript>alert(\'密码不能为空!\');history.go(-1)</script>';			} elseif($_POST['password']!=$_POST['cpassword']){			   echo '<script language=javascript>alert(\'二次密码不一致!\');history.go(-1)</script>';			} elseif($uid == -2) {				echo '<script language=javascript>alert(\'包含不允许注册的词语\');history.go(-1)</script>';			} elseif($uid == -3) {				echo '<script language=javascript>alert(\'用户名已经存在!\');history.go(-1)</script>';			} elseif($uid == -4) {				echo '<script language=javascript>alert(\'Email 格式有误!\');history.go(-1)</script>';			} elseif($uid == -5) {				echo '<script language=javascript>alert(\'Email 不允许注册!\');history.go(-1)</script>';			} elseif($uid == -6) {				echo '<script language=javascript>alert(\'该 Email 已经被注册!\');history.go(-1)</script>';			} else {				echo '<script language=javascript>alert(\'未定义\');history.go(-1)</script>';			}		} else {			$username     = $_POST['username'];			$password     = md5($_POST['password']);			$email        = $_POST['email'];			$name         = $_POST['name'];			$sex          = $_POST['sex'];			$place        = $_POST['place'];			$zip          = $_POST['zip'];			$qq           = $_POST['qq'];			$msn          = $_POST['msn'];			$tel          = $_POST['tel'];			$brithday     = time($_POST['brithday']);			$passquestion = $_POST['passquestion'];			$passanswer   = $_POST['passanswer'];		}	}	if($username) {		$db->query("INSERT INTO {$DB_dbprefix}member (id,user,password,email,name,sex,place,zip,qq,msn,tel,brithday,passquestion,passanswer) VALUES ('$uid','$username','".md5($_SESSION['active_password'])."','$email','$name','$sex','$place','$zip','$qq','$msn','$tel','$brithday','$passquestion','$passanswer')");		unset($_SESSION['active_password']);		//注册成功，设置 Cookie，加密直接用 uc_authcode 函数，用户使用自己的函数		$uid = mysql_insert_id( );		setcookie('tun2_auth', uc_authcode($uid."\t".$username, 'ENCODE'));		$_SESSION[ 'session_time ']=time();		$_SESSION['user_name'] = $username;		$_SESSION['uid'] = $uid;		echo '<script language="javascript">alert("注册成功");window.navigate("index.php");</script>';		exit;	}	}else{		    $username     = CheckUser($_POST['username']);			$password     = md5("".$_POST['password']."");			$cpassword    = md5($_POST['cpassword']);			$email        = CheckEmail($_POST['email'],'邮箱');			$name         = $_POST['name'];			$sex          = $_POST['sex'];			$place        = $_POST['place'];			$zip          = CheckZip($_POST['zip']);			$qq           = CheckNum($_POST['qq'],'QQ');			$msn          = CheckMSN($_POST['msn']);			$tel          = CheckNum($_POST['tel'],'电话');			$brithday     = time($_POST['brithday']);			$passquestion = CheckNull($_POST['passquestion'],'密码问题');			$passanswer   = CheckNull($_POST['passanswer'],'密码答案');									if (strtoupper($_POST['vcode']) != $_SESSION['vcode']) {                  echo '<script language=javascript>alert(\'验证码错误，请重新输入!\');history.go(-1)</script>';			   unset ($_SESSION['vcode']);	           exit( );            }			if ($_POST['password']==""){				echo '<script language=javascript>alert(\'密码不能为空,请重新输入!\');history.go(-1)</script>';			}			if ($_POST['cpassword']==""){				echo '<script language=javascript>alert(\'重复密码不能为空,请重新输入!\');history.go(-1)</script>';			}			if ($password!=$cpassword){				echo '<script language=javascript>alert(\'密码与重复密码不一致,请重新输入!\');history.go(-1)</script>';			}             $db->query( "SELECT * FROM {$DB_dbprefix}member WHERE user ='{$username}'" );		     if ( $db->next_record( ) ){                 echo '<script language=javascript>alert(\'用户名已经存在,请重新输入!\');history.go(-1)</script>';			 }else{				$db->query("INSERT INTO {$DB_dbprefix}member (id,user,password,email,name,sex,place,zip,qq,msn,tel,brithday,passquestion,passanswer) VALUES ('$uid','$username','$password','$email','$name','$sex','$place','$zip','$qq','$msn','$tel','$brithday','$passquestion','$passanswer')");				//注册成功		$uid = mysql_insert_id( );		$_SESSION[ 'session_time ']=time();		$_SESSION['user_name'] = $username;		$_SESSION['uid'] = $uid;		echo '<script language="javascript">alert("注册成功");window.navigate("index.php");</script>';		exit;			 }			unset ($_SESSION['vcode']);			    }}?><script language="javascript">function newgdcode(obj,url) {obj.src = url+ '?nowtime=' + new Date().getTime();}</script>