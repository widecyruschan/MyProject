<?phpout();$user=str_check(verify_null($_POST['user'],'登录账号'));$password=str_check(verify_null($_POST['password'],'登录密码'));$vcode=str_check($_POST['vcode']);if($_COOKIE['login_error']<10){if($_COOKIE['login_error']>3){if($_SESSION['vcode']){if($vcode!=$_SESSION['vcode']){echo "<script language=JavaScript>alert(\"验证码错误\");window.location.href=\"?controller=login&check=vcode\";</script>";exit();}}else{echo "<script language=JavaScript>alert(\"验证码不能为空\");window.location.href=\"?controller=login&check=vcode\"</script>";exit();}}$db->query( "SELECT * FROM {$DB_dbprefix}admin where user='{$user}'");if ( 0 <$db->next_record( ) ){if($db->Record["password"]==md5(md5($password).$db->Record["salt"])){$_SESSION['admin_user'] = $user;$hits=$db->Record["hits"]+1;$db->query( "UPDATE {$DB_dbprefix}admin SET `hits` =  '".$hits."',`lasttime` =  '".time()."',`ip` =  '".getIP()."',`lastip` =  '".$db->Record["ip"]."' where user='{$user}'");$_SESSION['admin_hits'] = $hits;addlog( "登录后台",$_SESSION['admin_user'] );header("Location:?controller=index");exit();}else{if(!$_COOKIE['login_error']){$_COOKIE['login_error']=1;}SetCookie("login_error",$_COOKIE['login_error']+1,time()+3600);echo "<script language=JavaScript>alert(\"账号或密码错误，已错误".$_COOKIE['login_error']."次，错误十次将锁定账号一小时\");javascript:history.go(-1);</script>";exit();}}else{SetCookie("login_error",$_COOKIE['login_error']+1,time()+3600);echo "账号或密码错误";}}else{echo $_COOKIE['login_error'];exit();}?>