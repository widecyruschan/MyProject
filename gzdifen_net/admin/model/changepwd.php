<?phpout();$oldpassword=str_check($_POST['oldpassword']);$oldpassword=md5(md5($oldpassword).$admin_salt);$password=str_check($_POST['password']);$user=$_SESSION['admin_user'];function randstr($len=6) {$chars='abcdefghijklmnopqrstuvwxyz0123456789';mt_srand((double)microtime()*1000000*getmypid());$password='';while(strlen($password)<$len) $password.=substr($chars,(mt_rand()%strlen($chars)),1);return $password;}$salt=randstr();$db->query("SELECT * FROM  `{$DB_dbprefix}admin` WHERE  `user` = '$user' AND `password` = '$oldpassword' LIMIT 0 , 1");if ($db->next_record( ) ){if($password==""){fail('密码不能为空');}else{$password=md5(md5($password).$salt);$db->query( "UPDATE  `{$DB_dbprefix}admin` SET  `password` =  '$password',`salt` =  '$salt' WHERE  `user` = '$user' AND `password` = '$oldpassword';");}addlog( "添加管理员{$user}",$_SESSION['admin_user']);done('添加成功','','');}else{fail('旧密码错误');}?>